module Scrap
  class ScrapService
    SCRAP_LINK = 'https://rubysec.com/advisories'.freeze
    SITE_LINK = 'https://rubysec.com'.freeze
    def initialize; end

    def scrap_data
      require 'open-uri'
      doc = Nokogiri::HTML(open(SCRAP_LINK))
      doc.css('table')[0].css('tr').each do |vulnerability|
        vulnerability_attr = {}
        vulnerability_attr[:date] = vulnerability.css('td')[0].text.strip.in_time_zone('UTC')
        vulnerability_attr[:rubygem] = vulnerability.css('td')[1].text.strip
        vulnerability_attr[:link] = SITE_LINK + vulnerability.css('td')[2].children[1].attr('href')
        vulnerability_attr[:title] = vulnerability.css('td')[2].text.strip
        vulnerability_attr[:cve] = vulnerability.css('td')[3].text.strip
        Vulnerability.create(vulnerability_attr) unless Vulnerability.where(link: vulnerability_attr[:link]).any?
      end
    end
  end
end
