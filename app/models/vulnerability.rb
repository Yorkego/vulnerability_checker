class Vulnerability < ApplicationRecord
  paginates_per 30

  after_create :send_email_and_slack_to_users, unless: :skip_send_email_to_users

  attr_accessor :skip_send_email_to_users

  private

  def send_email_and_slack_to_users
    User.find_each do |user|
      if user.slack.present?
        slack_client = Slack::Notifier.new user.slack
        slack_client.ping "New Vulnerability: #{link}"
      end
      UserMailer.new_vulnerability_email(user, self).deliver_later
    end
  end
end
