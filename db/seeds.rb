require 'open-uri'

SCRAP_LINK = 'https://rubysec.com/advisories'.freeze
SCRAP_WITH_PAGE_LINK = 'https://rubysec.com/advisories?page='.freeze
SITE_LINK = 'https://rubysec.com'.freeze

if Vulnerability.count == 0
  doc = Nokogiri::HTML(open(SCRAP_LINK))
  page_count = doc.search('.pagination').children[-3].text.to_i
  (1..page_count).each do |page_number|
    doc = Nokogiri::HTML(open(SCRAP_WITH_PAGE_LINK + page_number.to_s))
    doc.css('table')[0].css('tr').each do |vulnerability|
      vulnerability_attr = {}
      vulnerability_attr[:date] = vulnerability.css('td')[0].text.strip.in_time_zone('UTC')
      vulnerability_attr[:rubygem] = vulnerability.css('td')[1].text.strip
      vulnerability_attr[:link] = SITE_LINK + vulnerability.css('td')[2].children[1].attr('href')
      vulnerability_attr[:title] = vulnerability.css('td')[2].text.strip
      vulnerability_attr[:cve] = vulnerability.css('td')[3].text.strip
      vul = Vulnerability.new(vulnerability_attr)
      vul.skip_send_email_to_users = true
      vul.save
    end
  end
end
